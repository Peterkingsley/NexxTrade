<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join NexxTrade VIP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #0c0c0c;
            color: #f0f0f0;
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .glowing-border {
            box-shadow: 0 0 15px rgba(0, 194, 255, 0.5), 0 0 30px rgba(0, 194, 255, 0.3);
        }
        .form-container {
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00c2ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div id="main-container" class="w-full max-w-lg mx-auto">
            
            <div id="registration-form-container" class="form-container rounded-xl p-8 shadow-lg glowing-border">
                <div class="text-center mb-8">
                    <img src="/images/Nexxtrade.svg" alt="NexxTrade Logo" class="mx-auto h-12 mb-4">
                    <h1 class="text-3xl font-bold text-white">Join VIP</h1>
                    <p class="text-gray-400 mt-2">Complete your registration to get instant access.</p>
                </div>

                <form id="registration-form">
                    <div class="space-y-6">
                        <div>
                            <label for="fullname" class="block text-sm font-medium text-gray-300">Full Name</label>
                            <input type="text" id="fullname" name="fullname" required class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-300">Email Address</label>
                            <input type="email" id="email" name="email" required class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        <div>
                            <label for="telegram" class="block text-sm font-medium text-gray-300">Telegram Username</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">@</span>
                                <input type="text" id="telegram" name="telegram" required class="pl-7 mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                            </div>
                        </div>
                        <div>
                            <label for="whatsapp" class="block text-sm font-medium text-gray-300">WhatsApp Number</label>
                            <input type="tel" id="whatsapp" name="whatsapp" required class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500" placeholder="+1234567890">
                        </div>
                        <div>
                            <label for="plan" class="block text-sm font-medium text-gray-300">Select Your Plan</label>
                            <select id="plan" name="plan" required class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                                </select>
                        </div>
                        
                        <div>
                            <label for="payment_method" class="block text-sm font-medium text-gray-300">Payment Method</label>
                            <select id="payment_method" name="payment_method" required class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                                <option value="crypto">Crypto</option>
                                <option value="fiat">Fiat (Card, Bank Transfer)</option>
                            </select>
                        </div>
                        
                        <div id="crypto-fields">
                             <label for="pay_currency" class="block text-sm font-medium text-gray-300">Payment Network</label>
                             <select id="pay_currency" name="pay_currency" class="mt-1 block w-full bg-gray-800 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                                <option value="usdttrc20">USDT (TRC-20)</option>
                                <option value="usdtbsc">USDT (BEP-20)</option>
                            </select>
                        </div>

                    </div>
                    <div class="mt-8">
                        <button type="submit" id="submit-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 focus:ring-offset-gray-900">
                            Proceed to Payment
                        </button>
                    </div>
                </form>
            </div>

            <div id="payment-details-container" class="hidden form-container rounded-xl p-8 shadow-lg glowing-border text-center">
                <h2 class="text-2xl font-bold mb-4">Complete Your Payment</h2>
                <p id="payment-instructions" class="mb-4 text-gray-300"></p>
                <div class="flex justify-center my-4">
                    <img id="qr-code" src="" alt="QR Code">
                </div>
                <div class="bg-gray-800 p-3 rounded-lg break-words mb-4">
                    <span class="text-sm text-gray-400">Address:</span>
                    <p id="payment-address" class="font-mono text-cyan-400"></p>
                </div>
                <button id="copy-address-btn" class="mb-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-copy mr-2"></i>Copy Address
                </button>
                <div class="flex items-center justify-center space-x-3">
                    <div class="loader"></div>
                    <p class="text-gray-400">Awaiting payment confirmation...</p>
                </div>
                <p id="error-message" class="text-red-500 mt-4"></p>
            </div>
        </div>
    </div>

    <script>
        const registrationFormContainer = document.getElementById('registration-form-container');
        const paymentDetailsContainer = document.getElementById('payment-details-container');
        const registrationForm = document.getElementById('registration-form');
        const planSelect = document.getElementById('plan');
        const errorMessageElem = document.getElementById('error-message');
        const paymentMethodSelect = document.getElementById('payment_method');
        const cryptoFields = document.getElementById('crypto-fields');
        const submitButton = document.getElementById('submit-button');

        let plansData = [];
        let pollingInterval;

        // Fetch pricing plans and populate the select dropdown
        async function fetchPlans() {
            try {
                const response = await fetch('/api/pricing');
                if (!response.ok) throw new Error('Failed to fetch plans');
                plansData = await response.json();
                
                planSelect.innerHTML = '<option value="">--Please choose an option--</option>'; // Clear existing
                plansData.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.plan_name;
                    option.textContent = `${plan.plan_name} - $${plan.price} ${plan.term}`;
                    planSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Error fetching plans:', error);
                alert('Could not load pricing plans. Please refresh the page.');
            }
        }
        
        // NEW: Handle payment method change
        paymentMethodSelect.addEventListener('change', (e) => {
            if (e.target.value === 'crypto') {
                cryptoFields.style.display = 'block';
                submitButton.textContent = 'Proceed to Payment';
            } else {
                cryptoFields.style.display = 'none';
                submitButton.textContent = 'Proceed to Fiat Checkout';
            }
        });

        // Handle form submission
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessageElem.textContent = '';
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';

            const formData = new FormData(registrationForm);
            const selectedPlanName = formData.get('plan');
            const selectedPlan = plansData.find(p => p.plan_name === selectedPlanName);
            
            const paymentMethod = formData.get('payment_method');

            const commonDetails = {
                fullname: formData.get('fullname'),
                email: formData.get('email'),
                telegram: '@' + formData.get('telegram'),
                whatsapp_number: formData.get('whatsapp'),
                planName: selectedPlan.plan_name,
                priceUSD: selectedPlan.price,
            };

            if (paymentMethod === 'crypto') {
                await handleCryptoPayment(commonDetails, formData.get('pay_currency'));
            } else {
                await handleFiatPayment(commonDetails);
            }
        });
        
        async function handleCryptoPayment(details, pay_currency) {
            try {
                const response = await fetch('/api/payments/create-from-web', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...details, pay_currency }),
                });
                
                if (response.status === 409) {
                    const errorData = await response.json();
                    alert(errorData.message);
                    resetSubmitButton();
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to create payment.');
                }
                
                const data = await response.json();
                displayPaymentDetails(data);
                startPolling(data.order_id);

            } catch (error) {
                console.error('Crypto payment error:', error);
                alert(error.message);
                resetSubmitButton();
            }
        }

        async function handleFiatPayment(details) {
            try {
                 const response = await fetch('/api/payments/fiat/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(details),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to initiate Fiat payment.');
                }

                const data = await response.json();
                // Redirect user to the payment provider's page
                window.location.href = data.redirectUrl;

            } catch(error) {
                console.error('Fiat payment error:', error);
                alert(error.message);
                resetSubmitButton();
            }
        }

        function resetSubmitButton() {
             submitButton.disabled = false;
             submitButton.textContent = paymentMethodSelect.value === 'crypto' ? 'Proceed to Payment' : 'Proceed to Fiat Checkout';
        }

        function displayPaymentDetails(data) {
            registrationFormContainer.classList.add('hidden');
            paymentDetailsContainer.classList.remove('hidden');

            const networkMap = { 'usdttrc20': 'USDT (TRC-20)', 'usdtbsc': 'USDT (BEP-20)' };
            const formattedCurrency = networkMap[data.pay_currency.toLowerCase()] || data.pay_currency.toUpperCase();

            document.getElementById('payment-instructions').textContent = `Please send exactly ${data.pay_amount} ${formattedCurrency} to the address below.`;
            document.getElementById('payment-address').textContent = data.pay_address;
            document.getElementById('qr-code').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${data.pay_address}`;

            const copyBtn = document.getElementById('copy-address-btn');
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(data.pay_address).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.innerHTML = '<i class="fas fa-copy mr-2"></i>Copy Address'; }, 2000);
                });
            };
        }

        function startPolling(orderId) {
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/payments/status/${orderId}`);
                    if (!response.ok) {
                        clearInterval(pollingInterval);
                        errorMessageElem.textContent = 'Error checking status. Please refresh and try again.';
                        return;
                    }

                    const data = await response.json();

                    if (data.status === 'paid' && data.invite_link) {
                        clearInterval(pollingInterval);
                        // Redirect to the invite link on success
                        window.location.href = data.invite_link; 
                    }
                    
                } catch (error) {
                    console.error('Polling error:', error);
                    clearInterval(pollingInterval);
                    errorMessageElem.textContent = 'Could not verify payment. Please contact support.';
                }
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchPlans();
        });
    </script>
</body>
</html>