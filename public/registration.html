<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NexxTrade - Take your next trade with us</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <style>
    :root {
      --bg: #0b0f14;
      --bg-2: #0f141b;
      --text: #e9edf3;
      --muted: #a8b3c7;
      --accent: #2ad678;
      --danger: #ff5d5d;
      --line: #1b2330;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius: 16px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif;
    }

    .card {
      background: var(--bg-2);
      border-radius: var(--radius);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg);
      border-radius: 8px;
      font-weight: 600;
      transition: background .2s;
    }

    .btn-primary:hover {
      background: #25bd6a;
    }

    .form-input {
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 8px;
      color: var(--text);
    }
    
    .form-input:focus {
        border-color: var(--accent);
        outline: none;
    }

    #qrcode {
        border: 4px solid var(--line);
        border-radius: var(--radius);
        padding: 10px;
        background: white;
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-md">

    <div id="form-container" class="card">
        <div class="p-8">
            <img src="/images/Nexxtrade.svg" class="h-8 mx-auto mb-6" alt="NexxTrade">
            <h1 class="text-2xl font-bold text-center mb-1">Join VIP Access</h1>
            <p class="text-center text-sm text-muted mb-6">Create an account to continue</p>
            
            <div id="error-container" class="bg-red-500/10 text-danger text-sm p-3 rounded-lg mb-4" style="display:none;"></div>
            
            <form id="payment-form">
                <div class="space-y-4">
                    <input type="text" id="fullname" name="fullname" placeholder="Full Name" class="form-input w-full p-3" required>
                    <input type="email" id="email" name="email" placeholder="Email Address" class="form-input w-full p-3" required>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted">@</span>
                        <input type="text" id="telegram" name="telegram" placeholder="Telegram Username" class="form-input w-full p-3 pl-8" required>
                    </div>
                    <input type="tel" id="whatsapp" name="whatsapp" placeholder="WhatsApp Number (e.g. +123...)" class="form-input w-full p-3" required>
                    <select id="plan" name="plan" class="form-input w-full p-3" required></select>
                    <select id="pay_currency" name="pay_currency" class="form-input w-full p-3" required>
                        <option value="usdttrc20">USDT (TRC-20)</option>
                        <option value="usdtbsc">USDT (BEP-20)</option>
                    </select>
                </div>
                <button type="submit" id="submit-btn" class="btn-primary w-full p-3 mt-6">Proceed to Payment</button>
            </form>
        </div>
    </div>
    
    <div id="payment-container" class="card text-center" style="display:none;">
        <div class="p-8">
            <h2 class="text-xl font-bold mb-2">Complete Your Payment</h2>
            <p class="text-sm text-muted mb-4">Send exactly <strong id="payment-amount" class="text-accent"></strong> to the address below.</p>
            <div class="flex justify-center my-4">
                <div id="qrcode"></div>
            </div>
            <div class="bg-bg p-3 rounded-lg break-words">
                <p id="payment-address" class="font-mono text-sm"></p>
            </div>
            <p class="text-xs text-muted mt-6 animate-pulse">Waiting for blockchain confirmation...</p>
        </div>
    </div>
    
    <div id="success-container" class="card text-center" style="display:none;">
        <div class="p-8">
             <div class="w-16 h-16 bg-accent/10 rounded-full flex items-center justify-center mx-auto">
                <svg class="lucide lucide-check text-accent" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
            </div>
            <h2 class="text-xl font-bold mt-4">Payment Successful!</h2>
            <p class="text-sm text-muted mt-2 mb-6">Your access has been granted. Click the button below to join the VIP channel immediately.</p>
            <div id="join-link-container"></div>
        </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const formContainer = document.getElementById('form-container');
        const paymentContainer = document.getElementById('payment-container');
        const successContainer = document.getElementById('success-container');
        const errorContainer = document.getElementById('error-container');
        const form = document.getElementById('payment-form');
        const submitBtn = document.getElementById('submit-btn');
        const planSelect = document.getElementById('plan');

        let plansData = [];
        let paymentCheckInterval;
        
        const switchView = (activeView) => {
            [formContainer, paymentContainer, successContainer].forEach(v => v.style.display = 'none');
            activeView.style.display = 'block';
        };
        
        const displayError = (message) => {
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';
        };

        async function fetchAndPopulatePlans() {
            try {
                const response = await fetch('/api/pricing');
                if (!response.ok) throw new Error('Could not load pricing plans.');
                plansData = await response.json();
                planSelect.innerHTML = '<option value="">Select a Plan</option>';
                plansData.forEach(p => {
                    planSelect.innerHTML += `<option value="${p.plan_name}"> ${p.plan_name} - $${p.price} ${p.term}</option>`;
                });
            } catch (error) { displayError(error.message); }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorContainer.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            const formData = new FormData(form);
            const selectedPlanName = formData.get('plan');
            const selectedPlan = plansData.find(p => p.plan_name === selectedPlanName);
            
            if (!selectedPlan) {
                displayError("Please select a valid plan.");
                submitBtn.disabled = false;
                submitBtn.textContent = 'Proceed to Payment';
                return;
            }
            
            const payload = {
                fullname: formData.get('fullname'),
                email: formData.get('email'),
                telegram: '@' + formData.get('telegram'),
                whatsapp_number: formData.get('whatsapp'),
                planName: selectedPlan.plan_name,
                priceUSD: selectedPlan.price,
                pay_currency: formData.get('pay_currency'),
            };

            try {
                const response = await fetch('/api/payments/create-from-web', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                
                // --- NEW LOGIC START ---
                // Handle the case where the user already has this active subscription
                if (response.status === 409) {
                    const errorData = await response.json();
                    displayError(errorData.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Proceed to Payment';
                    return; // Stop the function here
                }
                // --- NEW LOGIC END ---

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'An unknown error occurred.' }));
                    throw new Error(errorData.message);
                }
                
                const data = await response.json();
                displayPaymentView(data);
                startPolling(data.order_id);

            } catch (error) {
                displayError(error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Proceed to Payment';
            }
        });

        function displayPaymentView(data) {
            document.getElementById('qrcode').innerHTML = '';
            document.getElementById('join-link-container').innerHTML = `<a href="#" id="join-link" class="btn-primary p-3 inline-block w-full">Click Here to Join VIP</a>`;
            
            switchView(paymentContainer);
            document.getElementById('payment-amount').textContent = `${data.pay_amount} ${data.pay_currency.toUpperCase()}`;
            document.getElementById('payment-address').textContent = data.pay_address;
            
            new QRCode(document.getElementById('qrcode'), {
                text: data.pay_address, width: 180, height: 180,
                colorDark: '#e9edf3', colorLight: '#0f141b'
            });
        }

        function startPolling(orderId) {
            if (paymentCheckInterval) clearInterval(paymentCheckInterval);
            paymentCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/payments/status/${orderId}`);
                    const data = await response.json();
                    if (data.status === 'paid' && data.invite_link) {
                        clearInterval(paymentCheckInterval);
                        displaySuccess(data.invite_link);
                    }
                } catch (error) { console.error('Polling error:', error); }
            }, 5000);
        }

        function displaySuccess(inviteLink) {
            switchView(successContainer);
            document.getElementById('join-link').href = inviteLink;
        }

        // --- Initialization ---
        fetchAndPopulatePlans();
    });
  </script>
</body>
</html>