<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://www.nexxtrade.io/images/Nexxtradeai.svg" type="image/svg+xml">
    <title>NexxTrade Admin Panel - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        /* Custom CSS to match the original site's theme and styles */
        :root {
            --bg: #0b0f14;
            --bg-2: #0f141b;
            --text: #e9edf3;
            --muted: #a8b3c7;
            --accent: #2ad678;
            --accent-2: #f0c75e;
            --danger: #ff5d5d;
            --line: #1b2330;
            --shadow: 0 8px 24px rgba(0,0,0,.35);
            --radius: 16px;
            --radius-lg: 20px;
        }

        /* Apply a consistent font and background */
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif; /* A font similar to the original site */
        }

        /* Style for the sidebar */
        .sidebar {
            background: var(--bg-2);
            border-right: 1px solid var(--line);
        }

        /* Style for dashboard cards */
        .card {
            background: var(--bg-2);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .card-header {
            border-bottom: 1px solid var(--line);
        }

        /* Table styles */
        .table-custom {
            width: 100%;
            border-collapse: collapse;
        }
        .table-custom th, .table-custom td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--line);
        }
        .table-custom thead th {
            background-color: var(--bg);
            font-weight: 600;
        }
        .table-custom tbody tr:hover {
            background-color: #121a23;
        }

        /* Green and Red text for PNL */
        .text-win { color: var(--accent); }
        .text-loss { color: var(--danger); }
        .text-neutral { color: var(--muted); }
    </style>
</head>
<body class="flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar w-64 min-h-screen p-4">
        <div class="sidebar-header flex items-center justify-center">
            <h1 class="text-xl font-bold">Admin Panel</h1>
        </div>
        <ul class="mt-6">
            <li class="mb-2 rounded hover:shadow hover:bg-slate-700">
                <a href="/admin/dashboard" class="flex items-center p-2 text-base font-normal">
                    <i data-lucide="layout-dashboard" class="w-6 h-6 text-gray-400"></i>
                    <span class="ml-3">Dashboard</span>
                </a>
            </li>
            <li class="mb-2 rounded hover:shadow hover:bg-slate-700">
                <a href="/admin/blogs" class="flex items-center p-2 text-base font-normal">
                    <i data-lucide="newspaper" class="w-6 h-6 text-gray-400"></i>
                    <span class="ml-3">Blogs</span>
                </a>
            </li>
            <li class="mb-2 rounded hover:shadow hover:bg-slate-700">
                <a href="/admin/performance" class="flex items-center p-2 text-base font-normal">
                    <i data-lucide="bar-chart-2" class="w-6 h-6 text-gray-400"></i>
                    <span class="ml-3">Performance</span>
                </a>
            </li>
            <li class="mb-2 rounded hover:shadow hover:bg-slate-700">
                <a href="/admin/pricing" class="flex items-center p-2 text-base font-normal">
                    <i data-lucide="tag" class="w-6 h-6 text-gray-400"></i>
                    <span class="ml-3">Pricing Plans</span>
                </a>
            </li>
            <li class="mb-2 rounded hover:shadow hover:bg-slate-700">
                <a href="/admin/payouts" class="flex items-center p-2 text-base font-normal">
                     <i data-lucide="dollar-sign" class="w-6 h-6 text-gray-400"></i>
                    <span class="ml-3">Payouts</span>
                </a>
            </li>
            <!-- NEW NOTIFICATION LINK ADDED HERE -->
            <li class="mb-2 rounded hover:shadow hover:bg-slate-700">
                <a href="/admin/notifications" class="flex items-center p-2 text-base font-normal">
                    <i data-lucide="bell" class="w-6 h-6 text-gray-400"></i>
                    <span class="ml-3">Notifications</span>
                </a>
            </li>
            <li class="mb-2 rounded hover:shadow hover:bg-slate-700">
                <a href="/admin/roles" class="flex items-center p-2 text-base font-normal">
                    <i data-lucide="users" class="w-6 h-6 text-gray-400"></i>
                    <span class="ml-3">Roles & Permissions</span>
                </a>
            </li>
            <!-- Logout Button -->
            <li class="mb-2 rounded hover:shadow hover:bg-slate-700">
                 <button id="logout-button" class="w-full flex items-center p-2 text-base font-normal">
                     <i data-lucide="log-out" class="w-6 h-6 text-gray-400"></i>
                     <span class="ml-3">Logout</span>
                 </button>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-10">
        <h1 class="text-3xl font-bold mb-8">Admin Dashboard</h1>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Active Users Card -->
            <div class="card p-5">
                <h2 class="text-sm font-medium text-muted mb-2">Total Active Users</h2>
                <p id="total-active-users" class="text-3xl font-bold">Loading...</p>
            </div>
            <!-- User Acquisition: Web -->
            <div class="card p-5">
                <h2 class="text-sm font-medium text-muted mb-2">Web Registrations (Active)</h2>
                <p id="web-registrations" class="text-3xl font-bold">Loading...</p>
            </div>
            <!-- User Acquisition: Bot -->
            <div class="card p-5">
                <h2 class="text-sm font-medium text-muted mb-2">Bot Registrations (Active)</h2>
                <p id="bot-registrations" class="text-3xl font-bold">Loading...</p>
            </div>
            <!-- User Acquisition: Referral -->
            <div class="card p-5">
                <h2 class="text-sm font-medium text-muted mb-2">Referral Signups (Active)</h2>
                <p id="referral-signups" class="text-3xl font-bold">Loading...</p>
            </div>
        </div>

        <!-- Tables for Recent Data -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Recent Users -->
            <div class="card">
                <div class="card-header p-4">
                    <h2 class="text-lg font-semibold">Recent Users</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="table-custom" id="users-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Telegram</th>
                                <th>Plan</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Blog Posts -->
            <div class="card">
                <div class="card-header p-4">
                    <h2 class="text-lg font-semibold">Recent Blog Posts</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="table-custom" id="blogs-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="blogs-table-body">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Signals Table -->
        <div class="card mt-8">
            <div class="card-header p-4">
                <h2 class="text-lg font-semibold">Recent Performance Signals</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="table-custom" id="signals-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Pair</th>
                            <th>Entry</th>
                            <th>Exit</th>
                            <th>PNL (%)</th>
                            <th>Leverage</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody id="signals-table-body">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Check for user session
            const user = JSON.parse(sessionStorage.getItem('nexxTradeAdmin'));
            if (!user) {
                window.location.href = '/admin'; // Redirect to login if not authenticated
                return;
            }

            // Logout functionality
            document.getElementById('logout-button').addEventListener('click', () => {
                sessionStorage.removeItem('nexxTradeAdmin');
                window.location.href = '/admin';
            });

            // Function to format dates
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            };

            // Fetch dashboard stats
            const fetchDashboardStats = async () => {
                try {
                    const response = await fetch('/api/dashboard-stats');
                    if (!response.ok) throw new Error('Failed to fetch stats');
                    const stats = await response.json();

                    document.getElementById('total-active-users').textContent = stats.totalActiveUsers || 0;
                    document.getElementById('web-registrations').textContent = stats.userAcquisition.web.active || 0;
                    document.getElementById('bot-registrations').textContent = stats.userAcquisition.bot.active || 0;
                    document.getElementById('referral-signups').textContent = stats.userAcquisition.referred.active || 0;
                } catch (error) {
                    console.error('Error fetching dashboard stats:', error);
                    // Display error message in cards
                    document.getElementById('total-active-users').textContent = 'Error';
                    document.getElementById('web-registrations').textContent = 'Error';
                    document.getElementById('bot-registrations').textContent = 'Error';
                    document.getElementById('referral-signups').textContent = 'Error';
                }
            };

            // Fetch data for the tables
            const fetchTableData = async () => {
                try {
                    const [usersRes, blogsRes, signalsRes] = await Promise.all([
                        fetch('/api/users?limit=5'),
                        fetch('/api/blogs?limit=5'),
                        fetch('/api/performances?limit=5')
                    ]);

                    // Populate recent users table
                    if (usersRes.ok) {
                        const users = await usersRes.json();
                        const usersTableBody = document.getElementById('users-table-body');
                        usersTableBody.innerHTML = ''; // Clear existing
                        users.slice(0, 5).forEach(user => {
                            const row = usersTableBody.insertRow();
                            const statusClass = user.subscription_status === 'active' ? 'text-win' : (user.subscription_status === 'pending' ? 'text-accent-2' : 'text-danger');
                            row.innerHTML = `
                                <td>${user.full_name}</td>
                                <td>${user.email}</td>
                                <td>${user.telegram_handle || 'N/A'}</td>
                                <td>${user.plan_name || 'N/A'}</td>
                                <td class="${statusClass}">${user.subscription_status}</td>
                            `;
                        });
                    }
                    
                    // Populate recent blogs table
                    if (blogsRes.ok) {
                        const blogs = await blogsRes.json();
                        const blogsTableBody = document.getElementById('blogs-table-body');
                        blogsTableBody.innerHTML = ''; // Clear existing
                        blogs.slice(0, 5).forEach(blog => {
                            const row = blogsTableBody.insertRow();
                            row.innerHTML = `
                                <td>${blog.title}</td>
                                <td>${blog.author}</td>
                                <td>${formatDate(blog.published_date)}</td>
                                <td>${blog.status}</td>
                            `;
                        });
                    }

                    // Populate recent signals table
                    if (signalsRes.ok) {
                        const signals = await signalsRes.json();
                        const signalsTableBody = document.getElementById('signals-table-body');
                        signalsTableBody.innerHTML = ''; // Clear existing
                        signals.slice(0, 5).forEach(signal => {
                            const row = signalsTableBody.insertRow();
                            const pnlValue = parseFloat(signal.pnl_percent.replace('%', ''));
                            let pnlClass = 'text-neutral';
                            if (pnlValue > 0) pnlClass = 'text-win';
                            if (pnlValue < 0) pnlClass = 'text-loss';

                            row.innerHTML = `
                                <td>${formatDate(signal.date)}</td>
                                <td>${signal.pair}</td>
                                <td>${signal.entry_price}</td>
                                <td>${signal.exit_price}</td>
                                <td class="${pnlClass}">${signal.pnl_percent}</td>
                                <td>${signal.leverage}</td>
                                <td>${signal.result_type}</td>
                            `;
                            signalsTableBody.appendChild(row);
                        });
                    }
                    lucide.createIcons();
                } catch (error) {
                    console.error('Error fetching table data:', error);
                    document.getElementById('users-table').innerHTML = `<tr><td colspan="5" class="text-danger text-center py-4">Failed to load user data.</td></tr>`;
                    document.getElementById('blogs-table').innerHTML = `<tr><td colspan="5" class="text-danger text-center py-4">Failed to load blog data.</td></tr>`;
                    document.getElementById('signals-table').innerHTML = `<tr><td colspan="7" class="text-danger text-center py-4">Failed to load signal data.</td></tr>`;
                }
            };

            // Initial data fetch on page load
            fetchDashboardStats();
            fetchTableData();
        });
    </script>
</body>
</html>
